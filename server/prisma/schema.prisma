generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ===================== ENUMS ===================== */

enum UserRole {
  ADMIN
  CLIENT
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum MatchStatus {
  OPEN
  CLOSED
  FINISHED
  CANCELED
}

enum OddType {
  HOME_WIN
  DRAW
  AWAY_WIN
}

enum BetSlipStatus {
  PENDING
  WON
  LOST
  CANCELED
}

enum NotificationType {
  SYSTEM
  BET
  PAYMENT
  MESSAGE
}

/* ===================== USER ===================== */

model User {
  id               String   @id @default(uuid())
  role             UserRole @default(CLIENT)
  name             String
  phone            String   @unique
  password         String

  balance          Decimal  @default(0) @db.Decimal(12, 2)
  totalDisponible  Decimal  @default(0) @db.Decimal(12, 2)
  isActive         Boolean  @default(true)

  transactions     Transaction[]
  betSlips         BetSlip[]
  notifications    Notification[]

  chats            Chat[]   @relation("UserChats")
  adminChats       Chat[]   @relation("AdminChats")
  messages         Message[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

/* ===================== TRANSACTIONS ===================== */

model Transaction {
  id            String             @id @default(uuid())
  userId        String
  type          TransactionType
  status        TransactionStatus  @default(PENDING)
  amount        Decimal            @db.Decimal(12, 2)
  reference     String?
  relatedSlipId String?

  user          User               @relation(fields: [userId], references: [id])

  createdAt     DateTime @default(now())
}

/* ===================== MATCH ===================== */

model Match {
  id          String       @id @default(uuid())
  homeTeam    String
  awayTeam    String
  startAt     DateTime
  status      MatchStatus @default(OPEN)

  odds        Odd[]
  picks       BetPick[]

  resultHome  Int?
  resultAway  Int?

  createdAt   DateTime @default(now())
}

/* ===================== ODD ===================== */

model Odd {
  id        String   @id @default(uuid())
  matchId  String
  type     OddType
  value    Decimal  @db.Decimal(6, 2)

  match    Match    @relation(fields: [matchId], references: [id])

  @@unique([matchId, type])
}

/* ===================== BET SLIP (FICHA) ===================== */

model BetSlip {
  id            String         @id @default(uuid())
  userId        String

  stake         Decimal        @db.Decimal(12, 2)
  totalOdd      Decimal        @db.Decimal(8, 2)
  possibleWin   Decimal        @db.Decimal(12, 2)

  status        BetSlipStatus  @default(PENDING)

  picks         BetPick[]

  user          User           @relation(fields: [userId], references: [id])

  createdAt     DateTime       @default(now())
  resolvedAt    DateTime?

  @@index([userId])
}

/* ===================== BET PICK ===================== */

model BetPick {
  id          String    @id @default(uuid())
  betSlipId   String
  matchId     String

  oddType     OddType
  oddValue    Decimal   @db.Decimal(6, 2)

  match       Match     @relation(fields: [matchId], references: [id])
  betSlip    BetSlip   @relation(fields: [betSlipId], references: [id])

  @@unique([betSlipId, matchId])
}

/* ===================== CHAT ===================== */

model Chat {
  id        String   @id @default(uuid())
  userId    String
  adminId   String

  user      User     @relation("UserChats", fields: [userId], references: [id])
  admin     User     @relation("AdminChats", fields: [adminId], references: [id])

  messages  Message[]

  createdAt DateTime @default(now())

  @@unique([userId, adminId])
}

/* ===================== MESSAGE ===================== */

model Message {
  id        String   @id @default(uuid())
  chatId    String
  senderId  String
  content   String
  isRead    Boolean  @default(false)

  chat      Chat     @relation(fields: [chatId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])

  createdAt DateTime @default(now())
}

/* ===================== NOTIFICATION ===================== */

model Notification {
  id        String            @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean           @default(false)

  user      User              @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
}
